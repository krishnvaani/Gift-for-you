<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Happy Birthday â€” Shared Diary</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<style>
:root{--primary:#8a4fff;--secondary:#a78bfa;--accent:#ff6b9d;--bg1:#e0f2fe;--bg2:#ede9fe;--bg3:#f3e8ff;--text:#222}
*{box-sizing:border-box}html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto;background:linear-gradient(135deg,var(--bg1),var(--bg2),var(--bg3));color:var(--text);-webkit-font-smoothing:antialiased}
.wrap{max-width:980px;margin:18px auto;padding:0 14px}
.card{background:rgba(255,255,255,0.92);border-radius:14px;box-shadow:0 10px 40px rgba(40,20,80,0.08);overflow:hidden}
.header{padding:14px;background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;text-align:center}
.header h1{margin:0;font-size:1.4rem;display:inline-block}
.header .edit-title{margin-left:12px;background:transparent;border:0;color:#fff;cursor:pointer}
.login{padding:18px;display:grid;gap:12px}
.row{display:flex;gap:10px;align-items:center}
input[type="text"],input[type="password"],select,textarea,input[type="date"],input[type="time"]{width:100%;padding:10px;border-radius:10px;border:1px solid #e7e7ee;font-size:0.95rem}
button.btn{background:linear-gradient(135deg,var(--primary),var(--secondary));color:white;border:0;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer}
button.ghost{background:transparent;border:1px solid rgba(0,0,0,0.06);color:var(--text);padding:8px;border-radius:8px;cursor:pointer}
.front{display:flex;flex-direction:column;align-items:center;padding:22px;gap:12px;text-align:center}
.visual{width:200px;height:200px;border-radius:12px;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,var(--primary),var(--accent));position:relative;overflow:hidden}
.visual img, .visual svg{max-width:100%;max-height:100%}
.img-edit{position:absolute;top:8px;right:8px;background:#fff;border-radius:50%;width:36px;height:36px;display:flex;align-items:center;justify-content:center;border:2px solid rgba(0,0,0,0.06);cursor:pointer}
.front-text{font-size:1.1rem;padding:12px;border-radius:10px;background:rgba(255,255,255,0.95);max-width:700px}
.controls{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:6px}
.main{display:none;margin-top:12px}
.tabs{display:flex;gap:8px;padding:8px}
.tab{flex:1;padding:10px;border-radius:10px;text-align:center;cursor:pointer;font-weight:700;color:#555}
.tab.active{background:linear-gradient(135deg,var(--primary),var(--secondary));color:white}
.content{padding:16px}
.grid{display:grid;grid-template-columns:1fr 360px;gap:16px;align-items:start}
@media(max-width:900px){.grid{grid-template-columns:1fr}.visual{width:150px;height:150px}}
.msg-card{background:white;border-radius:12px;padding:12px;box-shadow:0 6px 22px rgba(30,20,60,0.06);margin-bottom:12px;border-left:6px solid var(--primary)}
.small{font-size:0.9rem;color:#666}
.comments{margin-top:10px;padding-top:8px;border-top:1px dashed #eee}
.comment{padding:8px;background:#fafafa;border-radius:8px;margin-bottom:8px;border:1px solid #f0f0f2}
.modal-back{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;padding:20px;z-index:999}
.modal{background:#fff;border-radius:12px;padding:18px;max-width:820px;width:100%;max-height:90vh;overflow:auto}
.footer{padding:12px;text-align:center;color:#444;font-size:0.9rem}
.music-toggle{position:fixed;right:18px;bottom:18px;background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;padding:12px;border-radius:999px;box-shadow:0 8px 20px rgba(138,79,255,0.18);cursor:pointer;z-index:1000}
.color-sample{display:inline-block;width:18px;height:18px;border-radius:4px;border:1px solid #ddd;vertical-align:middle;margin-left:8px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="header">
      <h1 id="app-title">Happy Birthday</h1>
      <button class="edit-title" title="Edit title" onclick="openTitleEditor()"><i class="fas fa-edit"></i></button>
    </div>

    <!-- LOGIN -->
    <div id="login-area" class="login">
      <div style="display:flex;gap:12px;align-items:center;justify-content:center">
        <div class="visual" id="login-visual">
          <!-- SVG heart as default image -->
          <svg id="default-heart" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="#fff" d="M471.701 73.052c-54.5-46.8-136-38-186 15.6L256 118.3l-29.701-29.6c-50-53.6-131.5-62.4-186-15.6C-6.3 114.1-6.3 197.7 38.4 244l199.3 210.9c6.2 6.6 16.2 6.6 22.4 0L473.6 244c44.7-46.3 44.7-129.9-1.9-170.948z"/></svg>
        </div>
      </div>

      <div class="row">
        <input id="login-name" type="text" placeholder="Your name (e.g., Asha / Aman)" />
      </div>
      <div class="row">
        <select id="login-role">
          <option value="receiver">Receiver</option>
          <option value="admin">Admin</option>
        </select>
        <input id="login-pass" type="password" placeholder="Password" />
        <button class="btn" onclick="doLogin()">Login</button>
        <button class="ghost" onclick="loadSample()">Sample</button>
      </div>
      <div class="small">Default credentials: Admin = <strong>admin / admin</strong>, Receiver = <strong>receiver / receiver</strong>. Change them in Settings â†’ Help.</div>
    </div>

    <!-- FRONT -->
    <div id="front-area" class="front" style="display:none">
      <div class="visual" id="main-visual">
        <img id="main-image" src="" alt="heart photo placeholder" style="display:none"/>
        <!-- default inline svg heart shown if no image uploaded -->
        <svg id="main-heart" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="#fff" d="M471.701 73.052c-54.5-46.8-136-38-186 15.6L256 118.3l-29.701-29.6c-50-53.6-131.5-62.4-186-15.6C-6.3 114.1-6.3 197.7 38.4 244l199.3 210.9c6.2 6.6 16.2 6.6 22.4 0L473.6 244c44.7-46.3 44.7-129.9-1.9-170.948z"/></svg>
        <input id="img-upload" type="file" accept="image/*" style="display:none" />
        <div class="img-edit" title="Change image" onclick="document.getElementById('img-upload').click()"><i class="fas fa-camera"></i></div>
      </div>
      <div class="front-text" id="front-text">Every day with you is a new chapter in my favorite story.</div>
      <div class="controls">
        <button class="btn" onclick="openMain()">Open Diary</button>
        <button class="ghost" onclick="openSettings()">Settings</button>
      </div>
    </div>

    <!-- MAIN APP -->
    <div id="app-main" class="main" style="display:none">
      <div class="tabs">
        <div class="tab active" data-tab="read" onclick="switchTab(event)">Read</div>
        <div class="tab" data-tab="messages" onclick="switchTab(event)">Messages</div>
        <div class="tab" data-tab="reminders" onclick="switchTab(event)">Reminders</div>
        <div class="tab" data-tab="admin" onclick="switchTab(event)">Admin</div>
      </div>

      <div class="content">
        <div class="grid">
          <div id="left">
            <div id="tab-read" class="tab-content" style="display:block"><h3>Today's Message</h3><div id="today-area"></div></div>
            <div id="tab-messages" class="tab-content" style="display:none"><h3>Messages</h3><div id="scheduled-list"></div><div id="messages-list"></div></div>
            <div id="tab-reminders" class="tab-content" style="display:none"><h3>Reminders</h3><div id="reminders-list"></div></div>
          </div>
          <aside id="right">
            <div class="admin-panel">
              <strong id="user-welcome">Welcome</strong><div class="small" id="user-role-label"></div><hr/>
              <div><label><strong>Create message / poem</strong></label><input id="new-title" placeholder="Title (optional)"/><textarea id="new-content" placeholder="Write your message..."></textarea>
                <div style="display:flex;gap:8px"><input id="new-date" type="date"/><input id="new-time" type="time"/></div>
                <label class="small">Audio (optional)</label><input id="new-audio" type="file" accept="audio/*"/>
                <div style="margin-top:8px;display:flex;gap:8px"><button class="btn" onclick="createMessage()">Add</button><button class="ghost" onclick="clearComposer()">Clear</button></div>
              </div>
              <hr/>
              <div><label><strong>Create reminder</strong></label><div style="display:flex;gap:8px"><input id="rem-date" type="date"/><input id="rem-time" type="time"/></div><input id="rem-note" placeholder="Reminder note (optional)"/><div style="margin-top:8px;display:flex;gap:8px"><button class="btn" onclick="createReminder()">Set Reminder</button><button class="ghost" onclick="clearReminderForm()">Clear</button></div><div class="small">Allow browser notifications to receive pop-ups.</div></div>
              <hr/>
              <div><label><strong>Background Music</strong></label><div style="display:flex;gap:8px;align-items:center;margin-top:8px"><select id="music-choice" onchange="changeMusicChoice()"><option value="default_lofi">Lo-fi calm beats</option><option value="soft_piano">Soft Piano</option><option value="none">No music</option><option value="upload">Upload own</option></select><button class="btn" id="music-btn" onclick="toggleMusic()"><i class="fas fa-play"></i> Play</button></div><div class="small">Change default tracks in Settings â†’ Help.</div></div>
              <hr/>
              <div><label><strong>Quick actions</strong></label><div style="display:flex;gap:8px;margin-top:8px"><button class="ghost" onclick="exportData()">Export JSON</button><button class="ghost" onclick="importDataPrompt()">Import JSON</button><button class="ghost" onclick="resetAll()">Reset All</button></div><div class="small">Backup your data using Export.</div></div>
              <hr/>
              <div><label><strong>Help & Settings</strong></label><div class="small" style="margin-top:8px"><button class="ghost" onclick="openSettings()">Help / Settings</button></div></div>
            </div>
          </aside>
        </div>
      </div>
    </div>

    <div class="footer"><small>Host on GitHub Pages or Netlify for a permanent URL.</small></div>
  </div>
</div>

<button class="music-toggle" id="music-toggle" title="Play background music">ðŸŽµ</button>

<!-- Modal -->
<div id="modal" class="modal-back" onclick="modalRootClick(event)"><div class="modal"><h3 id="modal-title">Edit</h3><div id="modal-body"></div><div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px"><button class="ghost" onclick="closeModal()">Cancel</button><button class="btn" onclick="modalSave()">Save</button></div></div></div>

<script>
const KEY = 'hb-final-v1';
let state = null;
let currentUser = null;
let modalCtx = null;
let scheduleInterval = null;
let reminderInterval = null;
let bgAudio = null;
let musicPlaying = false;

function defaultState(){ return { nextId:1, settings:{ title:"Happy Birthday", frontText:"Every day with you is a new chapter in my favorite story.", frontImage:"", frontIcon:"heart", primaryColor:"#8a4fff", music:{ choice:"default_lofi", url_lofi:"https://assets.mixkit.co/music/preview/mixkit-lofi-chill-120.mp3", url_piano:"https://assets.mixkit.co/music/preview/mixkit-romantic-piano-120.mp3" }, credentials:{ adminUser:"admin", adminPass:"admin", receiverUser:"receiver", receiverPass:"receiver", receiverRequiresPass:true } }, users:[], messages:[], reminders:[] }; }

function load(){ const raw = localStorage.getItem(KEY); if(raw){ try{ state = JSON.parse(raw); }catch(e){ console.error(e); state = defaultState(); save(); } } else { state = defaultState(); save(); } }
function save(){ localStorage.setItem(KEY, JSON.stringify(state)); renderAll(); }
load();

document.addEventListener('DOMContentLoaded', ()=>{ document.getElementById('app-title').textContent = state.settings.title || "Happy Birthday"; document.getElementById('front-text').textContent = state.settings.frontText || ""; if(state.settings.frontImage) setMainImage(state.settings.frontImage); document.getElementById('music-choice').value = state.settings.music.choice || 'default_lofi'; document.getElementById('login-pass').value = ''; bgAudio = new Audio(); bgAudio.loop = true; renderAll(); });

function doLogin(){ const name = document.getElementById('login-name').value.trim(); const role = document.getElementById('login-role').value; const pass = document.getElementById('login-pass').value || ''; if(!name){ alert('Enter name'); return; } if(role==='admin'){ if(pass !== state.settings.credentials.adminPass){ alert('Wrong admin password'); return; } } else { if(state.settings.credentials.receiverRequiresPass && pass !== state.settings.credentials.receiverPass){ alert('Wrong receiver password'); return; } } currentUser={name,role}; if(!state.users.find(u=>u.name===name)) state.users.push({name,role}); save(); document.getElementById('login-area').style.display='none'; document.getElementById('front-area').style.display='flex'; document.getElementById('user-welcome').textContent = `Hello, ${name}`; document.getElementById('user-role-label').textContent = role==='admin'?'Signed in as Admin':'Signed in as Receiver'; requestNotificationPermission(); startLoops(); }

function openTitleEditor(){ modalCtx={type:'title'}; document.getElementById('modal-title').textContent='Edit Title'; document.getElementById('modal-body').innerHTML = `<div><input id="modal-title-input" value="${escapeHtml(state.settings.title)}" style="width:100%;padding:8px"/></div>`; openModal(); }
function setMainImage(dataUrl){ const img=document.getElementById('main-image'); const heart=document.getElementById('main-heart'); if(!dataUrl){ img.style.display='none'; heart.style.display='block'; } else { img.src=dataUrl; img.style.display='block'; heart.style.display='none'; } document.getElementById('login-visual').innerHTML = dataUrl?`<img src="${dataUrl}"/>`:`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="#fff" d="M471.701 73.052c-54.5-46.8-136-38-186 15.6L256 118.3l-29.701-29.6c-50-53.6-131.5-62.4-186-15.6C-6.3 114.1-6.3 197.7 38.4 244l199.3 210.9c6.2 6.6 16.2 6.6 22.4 0L473.6 244c44.7-46.3 44.7-129.9-1.9-170.948z"/></svg>`; }

document.getElementById('img-upload').addEventListener('change',(e)=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=(ev)=>{ state.settings.frontImage = ev.target.result; setMainImage(state.settings.frontImage); save(); alert('Image updated'); }; r.readAsDataURL(f); });

function openMain(){ document.getElementById('front-area').style.display='none'; document.getElementById('app-main').style.display='block'; renderAll(); }
function switchTab(e){ const el=e.currentTarget||e.target; const tab=el.getAttribute('data-tab'); document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); el.classList.add('active'); document.querySelectorAll('.tab-content').forEach(tc=>tc.style.display='none'); document.getElementById('tab-'+tab).style.display='block'; if(tab==='messages') renderMessages(); if(tab==='reminders') renderReminders(); if(tab==='read') renderToday(); }

function renderAll(){ document.getElementById('app-title').textContent = state.settings.title; document.documentElement.style.setProperty('--primary', state.settings.primaryColor || '#8a4fff'); document.getElementById('front-text').textContent = state.settings.frontText; if(state.settings.frontImage) setMainImage(state.settings.frontImage); renderToday(); renderMessages(); renderReminders(); }

function renderToday(){ const area=document.getElementById('today-area'); const today=new Date().toISOString().split('T')[0]; let msg=state.messages.find(m=>m.released && m.scheduled===today) || state.messages.filter(m=>m.released).slice(-1)[0]; if(!msg){ area.innerHTML=`<div class="msg-card"><div class="small">No content for today.</div></div>`; return; } area.innerHTML = buildMessage(msg,true); }

function renderMessages(){ const list=document.getElementById('messages-list'); const live=state.messages.filter(m=>m.released); list.innerHTML = live.length? live.slice().reverse().map(m=>buildMessage(m,false)).join('') : `<div class="small">No messages yet.</div>`; const scheduledArea=document.getElementById('scheduled-list'); const scheduled=state.messages.filter(m=>!m.released && m.scheduled); scheduledArea.innerHTML = scheduled.length? '<div style="font-weight:700">Upcoming</div>' + scheduled.slice().sort((a,b)=>new Date(a.scheduled+'T'+(a.scheduledTime||'09:00'))-new Date(b.scheduled+'T'+(b.scheduledTime||'09:00'))).map(m=>`<div class="msg-card" style="border-left:6px solid #ccc"><div style="display:flex;justify-content:space-between"><div><div style="font-weight:700">${escapeHtml(m.title||'(Scheduled)')}</div><div class="small">Scheduled: ${escapeHtml(m.scheduled)} ${m.scheduledTime? 'â€¢ '+escapeHtml(m.scheduledTime):''}</div></div>${(currentUser && currentUser.role==='admin')?`<div><button class="ghost" onclick="openEditModal('edit',${m.id})"><i class='fas fa-edit'></i></button></div>`:''}</div><div class="small" style="margin-top:8px">Content hidden until release.</div></div>`).join('') : ''; }

function renderReminders(){ const area=document.getElementById('reminders-list'); if(!state.reminders.length){ area.innerHTML = `<div class="small">No reminders</div>`; return; } area.innerHTML = state.reminders.slice().sort((a,b)=>new Date(a.when)-new Date(b.when)).map(r=>`<div class="rem-card"><div style="display:flex;justify-content:space-between"><div><div style="font-weight:700">${escapeHtml(r.note||'(Reminder)')}</div><div class="small">By: ${escapeHtml(r.by)} â€¢ ${new Date(r.when).toLocaleString()}</div></div>${(currentUser && currentUser.role==='admin')?`<div><button class="ghost" onclick="removeReminder(${r.id})"><i class='fas fa-trash'></i></button></div>`:''}</div></div>`).join(''); }

function buildMessage(m,large=false){ const dt=new Date(m.created).toLocaleString(); const scheduled = m.scheduled? `<div class="small">Scheduled: ${m.scheduled}${m.scheduledTime? ' â€¢ '+m.scheduledTime:''}</div>` : ''; const posted = `<div class="small">Posted on: ${new Date(m.postedOn||m.created).toLocaleString()}</div>`; const audio = m.audio? `<div class="small" style="margin-top:8px"><audio controls src="${m.audio}"></audio></div>` : ''; const comments = m.comments && m.comments.length? m.comments.map(c=>`<div class="comment"><div class="meta"><strong>${escapeHtml(c.by)}</strong> â€¢ ${new Date(c.when).toLocaleString()}</div><div>${escapeHtml(c.text)}</div></div>`).join('') : `<div class="small">No comments</div>`; return `<div class="msg-card" data-id="${m.id}"><div style="display:flex;justify-content:space-between"><div><div class="msg-title">${escapeHtml(m.title||'(Untitled)')}</div><div class="small">By: ${escapeHtml(m.author)} â€¢ ${dt}</div></div><div>${(currentUser && (currentUser.role==='admin'||currentUser.name===m.author))?`<button class="ghost" onclick="openEditModal('edit',${m.id})"><i class='fas fa-edit'></i></button>`:''}${(currentUser && currentUser.role==='admin')?`<button class="ghost" onclick="deleteMessage(${m.id})"><i class='fas fa-trash' style='color:#d33'></i></button>`:''}</div></div><div class="msg-body">${escapeHtml(m.content)}</div>${scheduled}${posted}${audio}<div class="comments" id="comments-${m.id}"><div style="font-weight:700;margin-bottom:6px">Aap kuch kehna chahenge ?</div>${comments}<div style="display:flex;gap:8px;margin-top:8px"><input id="comment-input-${m.id}" placeholder="Type your comment..." style="flex:1;padding:8px;border-radius:8px;border:1px solid #eee"/><button class="btn" onclick="submitComment(${m.id})">Send</button></div><div style="margin-top:8px;display:flex;gap:8px"><button class="ghost" onclick="openEditModal('rem',${m.id})"><i class='fas fa-bell'></i> Add reminder</button></div></div></div>`; }

function clearComposer(){ document.getElementById('new-title').value=''; document.getElementById('new-content').value=''; document.getElementById('new-date').value=''; document.getElementById('new-time').value=''; document.getElementById('new-audio').value=''; }
function createMessage(){ if(!currentUser){ alert('Login first'); return; } const title=document.getElementById('new-title').value.trim(); const content=document.getElementById('new-content').value.trim(); if(!content){ alert('Write content'); return; } const scheduled=document.getElementById('new-date').value||null; const scheduledTime=document.getElementById('new-time').value||null; const file=document.getElementById('new-audio').files[0]; if(file){ const r=new FileReader(); r.onload=(e)=> finalize(e.target.result); r.readAsDataURL(file); } else finalize(null); function finalize(audioData){ const released = scheduled? false:true; const postedOn = released? new Date().toISOString() : null; const m = { id: state.nextId++, title, content, author: currentUser.name, created:new Date().toISOString(), scheduled, scheduledTime, released, postedOn, audio:audioData, comments:[] }; state.messages.push(m); save(); clearComposer(); alert('Message saved' + (released? ' and published.':' as scheduled.')); } }

function submitComment(mid){ const input=document.getElementById(`comment-input-${mid}`); if(!input) return; const txt=input.value.trim(); if(!txt) return alert('Write comment'); const msg=state.messages.find(m=>m.id===mid); msg.comments = msg.comments||[]; msg.comments.push({ id: state.nextId++, by: currentUser.name, when:new Date().toISOString(), text:txt }); save(); input.value=''; renderMessages(); }
function deleteMessage(id){ if(!confirm('Delete?')) return; state.messages = state.messages.filter(m=>m.id!==id); save(); }
function createReminder(){ if(!currentUser){ alert('Login'); return; } const date=document.getElementById('rem-date').value; if(!date) return alert('Choose date'); const time=document.getElementById('rem-time').value||'09:00'; const note=document.getElementById('rem-note').value.trim(); const when=new Date(date+'T'+time).toISOString(); const r={ id: state.nextId++, by: currentUser.name, when, note, notified:false }; state.reminders.push(r); save(); clearReminderForm(); alert('Reminder set'); } function clearReminderForm(){ document.getElementById('rem-date').value=''; document.getElementById('rem-time').value=''; document.getElementById('rem-note').value=''; } function removeReminder(id){ if(!confirm('Delete reminder?')) return; state.reminders = state.reminders.filter(r=>r.id!==id); save(); }

function openEditModal(mode,id){ modalCtx={mode,id}; const body=document.getElementById('modal-body'); if(mode==='edit'){ const m=state.messages.find(x=>x.id===id); if(!m){ alert('Not found'); return; } document.getElementById('modal-title').textContent='Edit Message'; body.innerHTML=`<div class="row"><label>Title</label><input id="modal-msg-title" value="${escapeHtml(m.title||'')}"/></div><div class="row"><label>Content</label><textarea id="modal-msg-content" style="min-height:120px">${escapeHtml(m.content||'')}</textarea></div><div class="row"><label>Scheduled date</label><input id="modal-msg-date" type="date" value="${m.scheduled||''}"/></div><div class="row"><label>Scheduled time</label><input id="modal-msg-time" type="time" value="${m.scheduledTime||''}"/></div><div class="row"><label>Replace audio</label><input id="modal-msg-audio" type="file" accept="audio/*"/></div>`; openModal(); } else if(mode==='rem'){ document.getElementById('modal-title').textContent='Add Reminder'; body.innerHTML=`<div class="row"><label>Date</label><input id="modal-rem-date" type="date"/></div><div class="row"><label>Time</label><input id="modal-rem-time" type="time"/></div><div class="row"><label>Note</label><input id="modal-rem-note"/></div>`; openModal(); } else if(mode==='help'){ document.getElementById('modal-title').textContent='Help & Settings'; body.innerHTML=`<div class="row"><h4>Hosting</h4><p>Use GitHub Pages or Netlify. See README for steps.</p></div><div class="row"><label>Admin user</label><input id="help-admin-user" value="${escapeHtml(state.settings.credentials.adminUser)}"/></div><div class="row"><label>Admin pass</label><input id="help-admin-pass" value="${escapeHtml(state.settings.credentials.adminPass)}"/></div><div class="row"><label>Receiver user</label><input id="help-rec-user" value="${escapeHtml(state.settings.credentials.receiverUser)}"/></div><div class="row"><label>Receiver pass</label><input id="help-rec-pass" value="${escapeHtml(state.settings.credentials.receiverPass)}"/></div><div class="row"><label>Require receiver password?</label><select id="help-rec-req"><option value="true">Yes</option><option value="false">No</option></select></div><div class="row"><label>Lo-fi URL</label><input id="help-lofi" value="${escapeHtml(state.settings.music.url_lofi)}"/></div><div class="row"><label>Soft piano URL</label><input id="help-piano" value="${escapeHtml(state.settings.music.url_piano)}"/></div><div class="row"><label>Primary color (hex)</label><input id="help-color" value="${escapeHtml(state.settings.primaryColor)}"/><span class="color-sample" id="color-sample" style="background:${escapeHtml(state.settings.primaryColor)}"></span></div>`; openModal(); setTimeout(()=>{ document.getElementById('help-rec-req').value = state.settings.credentials.receiverRequiresPass ? 'true':'false'; },20); } else if(mode==='title'){ document.getElementById('modal-title').textContent='Edit Title'; body.innerHTML=`<div class="row"><input id="modal-title-input" value="${escapeHtml(state.settings.title)}" /></div>`; openModal(); } }

function modalSave(){ if(!modalCtx){ closeModal(); return; } const mode = modalCtx.mode; if(mode==='edit'){ const id = modalCtx.id; const m = state.messages.find(x=>x.id===id); m.title = document.getElementById('modal-msg-title').value; m.content = document.getElementById('modal-msg-content').value; m.scheduled = document.getElementById('modal-msg-date').value||null; m.scheduledTime = document.getElementById('modal-msg-time').value||null; const f = document.getElementById('modal-msg-audio'); if(f && f.files && f.files[0]){ const r=new FileReader(); r.onload=(e)=>{ m.audio = e.target.result; save(); closeModal(); alert('Updated'); }; r.readAsDataURL(f.files[0]); } else { save(); closeModal(); alert('Updated'); } } else if(mode==='rem'){ const date = document.getElementById('modal-rem-date').value; if(!date) return alert('Pick date'); const time = document.getElementById('modal-rem-time').value||'09:00'; const note = document.getElementById('modal-rem-note').value.trim(); const when = new Date(date+'T'+time).toISOString(); const r = { id: state.nextId++, by: currentUser.name, when, note, notified:false, forMessageId: modalCtx.id }; state.reminders.push(r); save(); closeModal(); alert('Reminder added'); } else if(mode==='help'){ const au = document.getElementById('help-admin-user').value.trim()||'admin'; const ap = document.getElementById('help-admin-pass').value||'admin'; const ru = document.getElementById('help-rec-user').value.trim()||'receiver'; const rp = document.getElementById('help-rec-pass').value||'receiver'; const rr = document.getElementById('help-rec-req').value==='true'; const lofi = document.getElementById('help-lofi').value.trim(); const piano = document.getElementById('help-piano').value.trim(); const col = document.getElementById('help-color').value.trim()||'#8a4fff'; state.settings.credentials.adminUser=au; state.settings.credentials.adminPass=ap; state.settings.credentials.receiverUser=ru; state.settings.credentials.receiverPass=rp; state.settings.credentials.receiverRequiresPass=rr; if(lofi) state.settings.music.url_lofi=lofi; if(piano) state.settings.music.url_piano=piano; state.settings.primaryColor=col; document.getElementById('color-sample').style.background=col; save(); closeModal(); alert('Saved settings'); } else if(mode==='title'){ const v=document.getElementById('modal-title-input').value.trim(); if(v) state.settings.title=v; save(); closeModal(); } }

function openModal(){ document.getElementById('modal').style.display='flex'; }
function closeModal(){ document.getElementById('modal').style.display='none'; modalCtx=null; }
function modalRootClick(e){ if(e.target.classList && e.target.classList.contains('modal-back')) closeModal(); }

function requestNotificationPermission(){ if(!('Notification' in window)) return; if(Notification.permission==='default') Notification.requestPermission().then(p=>console.log('perm',p)); }
function startLoops(){ if(scheduleInterval) clearInterval(scheduleInterval); if(reminderInterval) clearInterval(reminderInterval); scheduleInterval=setInterval(checkScheduled,30000); reminderInterval=setInterval(checkReminders,60000); checkScheduled(); checkReminders(); }
function checkScheduled(){ const now=new Date(); let changed=false; state.messages.forEach(m=>{ if(m.released) return; if(!m.scheduled) return; const time = m.scheduledTime||'09:00'; const when = new Date(m.scheduled+'T'+time); if(when<=now){ m.released=true; m.postedOn=new Date().toISOString(); changed=true; notifyRelease(m); } }); if(changed) save(); }
function notifyRelease(m){ const title = "A message arrived ðŸ’Œ"; const body = (m.title? m.title + " â€¢ ":"") + "From: " + (m.author||''); try{ const s = new Audio(state.settings.music.url_lofi); s.volume=0.8; s.play().catch(()=>{}); }catch(e){} if('Notification' in window && Notification.permission==='granted'){ try{ const n=new Notification(title,{body}); n.onclick=()=>window.focus(); }catch(e){ alert(title+"\n"+body); } } else { alert(title+"\n"+body); } }
function checkReminders(){ const now=new Date(); state.reminders.forEach(r=>{ if(r.notified) return; const when=new Date(r.when); if(when<=now){ r.notified=true; save(); dispatchReminder(r); } }); }
function dispatchReminder(r){ const title='Reminder â€¢ Happy Birthday'; const body=(r.note||'Reminder') + ' â€¢ By: ' + r.by; try{ const s=new Audio(state.settings.music.url_lofi); s.play().catch(()=>{}); }catch(e){} if('Notification' in window && Notification.permission==='granted'){ try{ const n=new Notification(title,{body}); n.onclick=()=>window.focus(); }catch(e){ alert(title+"\n"+body); } } else { alert(title+"\n"+body); } }

function openSettings(){ openEditModal('help'); }
function openEditModal(mode,id){ modalCtx={mode,id}; const body=document.getElementById('modal-body'); if(mode==='edit'){ const m=state.messages.find(x=>x.id===id); if(!m){ alert('Not found'); return; } document.getElementById('modal-title').textContent='Edit Message'; body.innerHTML=`<div class="row"><label>Title</label><input id="modal-msg-title" value="${escapeHtml(m.title||'')}"/></div><div class="row"><label>Content</label><textarea id="modal-msg-content" style="min-height:120px">${escapeHtml(m.content||'')}</textarea></div><div class="row"><label>Scheduled date</label><input id="modal-msg-date" type="date" value="${m.scheduled||''}"/></div><div class="row"><label>Scheduled time</label><input id="modal-msg-time" type="time" value="${m.scheduledTime||''}"/></div><div class="row"><label>Replace audio</label><input id="modal-msg-audio" type="file" accept="audio/*"/></div>`; openModal(); } else if(mode==='rem'){ document.getElementById('modal-title').textContent='Add Reminder'; body.innerHTML=`<div class="row"><label>Date</label><input id="modal-rem-date" type="date"/></div><div class="row"><label>Time</label><input id="modal-rem-time" type="time"/></div><div class="row"><label>Note</label><input id="modal-rem-note"/></div>`; openModal(); } else if(mode==='help'){ document.getElementById('modal-title').textContent='Help & Settings'; body.innerHTML=`<div class="row"><h4>Hosting</h4><p>Use GitHub Pages or Netlify. See README for steps.</p></div><div class="row"><label>Admin user</label><input id="help-admin-user" value="${escapeHtml(state.settings.credentials.adminUser)}"/></div><div class="row"><label>Admin pass</label><input id="help-admin-pass" value="${escapeHtml(state.settings.credentials.adminPass)}"/></div><div class="row"><label>Receiver user</label><input id="help-rec-user" value="${escapeHtml(state.settings.credentials.receiverUser)}"/></div><div class="row"><label>Receiver pass</label><input id="help-rec-pass" value="${escapeHtml(state.settings.credentials.receiverPass)}"/></div><div class="row"><label>Require receiver password?</label><select id="help-rec-req"><option value="true">Yes</option><option value="false">No</option></select></div><div class="row"><label>Lo-fi URL</label><input id="help-lofi" value="${escapeHtml(state.settings.music.url_lofi)}"/></div><div class="row"><label>Soft piano URL</label><input id="help-piano" value="${escapeHtml(state.settings.music.url_piano)}"/></div><div class="row"><label>Primary color (hex)</label><input id="help-color" value="${escapeHtml(state.settings.primaryColor)}"/><span class="color-sample" id="color-sample" style="background:${escapeHtml(state.settings.primaryColor)}"></span></div>`; openModal(); setTimeout(()=>{ document.getElementById('help-rec-req').value = state.settings.credentials.receiverRequiresPass ? 'true':'false'; },20); } else if(mode==='title'){ document.getElementById('modal-title').textContent='Edit Title'; body.innerHTML=`<div class="row"><input id="modal-title-input" value="${escapeHtml(state.settings.title)}" /></div>`; openModal(); } }

function escapeHtml(s){ if(!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

// export/import/reset helpers
function exportData(){ const json=JSON.stringify(state,null,2); const blob=new Blob([json],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='happybirthday-backup.json'; a.click(); URL.revokeObjectURL(url); }
function importDataPrompt(){ const f=document.createElement('input'); f.type='file'; f.accept='application/json'; f.onchange=(e)=>{ const file=e.target.files[0]; if(!file) return; const r=new FileReader(); r.onload=(ev)=>{ try{ state=JSON.parse(ev.target.result); save(); alert('Imported'); }catch(err){ alert('Invalid JSON'); } }; r.readAsText(file); }; f.click(); }
function resetAll(){ if(!confirm('Reset all local data?')) return; localStorage.removeItem(KEY); state=defaultState(); save(); alert('Reset'); }

// final save call to ensure updated state on load
save();
</script>
</body>
</html>
